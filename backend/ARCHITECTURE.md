# Database Architecture - Questions & Answers

## 1. Test Database Connection ‚úÖ

**Tests use a separate test database.**

- **Dev DB**: `backend_db` (port 5432)
- **Test DB**: `backend_test_db` (port 5432)

Configuration in [tests/conftest.py](tests/conftest.py#L10):

```python
test_engine = create_engine(settings.database_test_url)
```

Each test runs in a **transaction that gets rolled back**, so:

- Tests don't pollute each other
- No cleanup needed between tests
- Test database stays clean

## 2. Models vs Schemas üìö

### models.py (SQLAlchemy ORM)

- **What**: Database tables definition
- **Where**: [app/users/models.py](app/users/models.py)
- **Purpose**: Defines what gets stored in PostgreSQL
- **Example**:

```python
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    username = Column(String, unique=True)
    password = Column(String)
```

### schemas.py (Pydantic)

- **What**: API request/response validation
- **Where**: [app/users/schemas.py](app/users/schemas.py)
- **Purpose**: Validates data coming in/out of HTTP requests
- **Example**:

```python
class UserCreate(BaseModel):
    username: str = Field(..., min_length=3)
    password: str = Field(..., min_length=6)  # Never returned in response

class UserResponse(BaseModel):
    id: int
    username: str  # No password field!
```

**Flow**:

1. User sends JSON ‚Üí Pydantic `UserCreate` validates it
2. Service layer uses validated data ‚Üí Creates SQLAlchemy `User` model
3. Save to DB ‚Üí Return SQLAlchemy model
4. Convert to Pydantic `UserResponse` ‚Üí Send JSON back (without password!)

## 3. Database Migrations with Alembic üîÑ

### Quick Start

**Create a migration** (after changing models):

```bash
make migrate-create MSG="add email to users"
```

**Apply migrations**:

```bash
make migrate-up
```

**Rollback last migration**:

```bash
make migrate-down
```

**Check current version**:

```bash
make migrate-current
```

### How It Works

1. **Alembic tracks changes** to your models in [app/users/models.py](app/users/models.py)
2. **Generates migration scripts** in `alembic/versions/`
3. **Maintains version history** in `alembic_version` table

### Configuration Files

- [alembic.ini](alembic.ini) - Main config (uses `.env` for DB URL)
- [alembic/env.py](alembic/env.py) - Imports all models for autogenerate
- `alembic/versions/` - Migration scripts (timestamped)

### Example Workflow

1. Add new field to model:

```python
# app/users/models.py
class User(Base):
    email = Column(String, unique=True)  # NEW
```

2. Create migration:

```bash
make migrate-create MSG="add email to users"
```

3. Review generated file in `alembic/versions/`

4. Apply migration:

```bash
make migrate-up
```

### Important Notes

- ‚úÖ Migrations run on **dev database** only
- ‚úÖ Tests use `conftest.py` which **creates tables directly** (not via migrations)
- ‚úÖ Always create migrations for model changes
- ‚úÖ Commit migration files to git
- ‚ö†Ô∏è Review autogenerated migrations before applying
